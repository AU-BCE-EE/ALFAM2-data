---
title: 'Submitted data error checks'
output: html_document
classoption: landscape
author: 
date: "`r format(Sys.time(), '%d %B, %Y %H:%M')`"
---

# Submitter and contributors
```{r, echo = FALSE}
kable(dat[[i]][[j]]$submitter[, -1], row.names = FALSE)
kable(dat[[i]][[j]]$contrib, row.names = FALSE)
```

# File and directory names
```{r, echo = FALSE}
print(i)
print(j)
```

# Location
```{r, echo = FALSE}
library( leaflet )
library( magrittr )
```

```{r, echo = FALSE}
plots <- dat[[i]][[j]]$plots
ll <- unique(plots[, c('lat', 'long')])

subscr <- data.frame(lat=c(ll$lat),
                    lon=c(ll$long))

leaflet() %>% addTiles() %>% 
  addCircleMarkers(data = subscr,
                   lat = ~lat, lng = ~lon,
                   color = "blue")

```

# Check experiment etc. codes (IDs)
```{r, echo = FALSE}
exper <- dat[[i]][[j]]$exper
treat <- dat[[i]][[j]]$treat
emis <- dat[[i]][[j]]$emis
pubs <- dat[[i]][[j]]$pubs
```

## Codes in Treatments sheet
```{r, echo = FALSE}
if (all(exper$exper %in% treat$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Treatments sheet.')
}

if (all(treat$exper %in% exper$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Experiments sheet.')
}
```

## Codes in Plots sheet
```{r, echo = FALSE}
if (all(exper$exper %in% plots$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Plots sheet.')
}

if (all(plots$exper %in% exper$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Experiments sheet.')
}
```

## Codes in Emission sheet
```{r, echo = FALSE}
if (all(exper$exper %in% emis$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Emission sheet.')
}

if (all(emis$exper %in% exper$exper)) {
  print('OK')
} else {
  print('Missing experiment codes in Experiments sheet.')
}
```

## Code merge check (matching project, experiment, field, plot, treatment)
```{r, echo = FALSE}
m1 <- merge(exper, treat, all = TRUE)
m2 <- merge(m1, emis, all = TRUE)

if (nrow(m1) == nrow(treat)) {
  print('OK')
} else {
  print('Merge problem 1')
  print(intersect(names(exper), names(treat)))
}

if (sum(is.na(c(m1$proj, m1$exper, m1$treat))) == 0) {
  print('OK')
} else {
  print('Merge problem 2')
}

if (nrow(m1) == max(nrow(treat), nrow(exper))) {
  print('OK')
} else {
  print('Merge problem 3')
}

if (sum(is.na(c(m2$proj, m2$exper, m2$treat, m2$field, m2$plot))) == 0) {
  print('OK')
} else {
  print('Merge problem 4')
  md <- m2[is.na(m2$proj) | is.na(m2$exper) | is.na(m2$field) | is.na(m2$plot), c('row.in.file.plot', 'row.in.file.int', 'proj', 'exper', 'pub.id', 'treat', 'field', 'plot')]
  md <- unique(md)
  print(md)
  #unique(emis[, c('proj', 'exper', 'pub.id', 'treat', 'field', 'plot')])
  #intersect(names(m1), names(emis))
}

if (nrow(m2) == nrow(emis)) {
  print('OK')
} else {
  print('Merge problem 5')
  print('Some unmatched codes/names present')
  print('First 5 rows after merge:')
  print(m2[1:5, c('row.in.file.plot', 'row.in.file.int', 'proj', 'exper', 'pub.id', 'treat', 'field', 'plot')])
  stop('Merge problem 2, see error_check.Rmd')
}

#if (sum(is.na(c(m3$proj, m3$exper, m3$treat, m3$field, m3$plot))) == 0) {
#  print('OK')
#} else {
#  print('Merge problem 6')
#  md <- m3[any(is.na(m3$proj), is.na(m3$exper), is.na(m3$treat), is.na(m3$field), is.na(m3$plot)), c('row.in.file.plot', 'row.in.file.int', 'proj', 'exper', 'treat', 'field', 'plot')]
#  md <- unique(md)
#  print(paste('Problems in', nrow(md), 'rows.'))
#  print('First 10 rows:')
#  print(md[1:min(10, nrow(md)), ])
#}

```

# Publication info
## Check for missing codes
```{r, echo = FALSE}
if (all(exper$pub.id %in% pubs$pub.id)) {
  print('OK') 
} else {
  print('Missing pub codes in Publications sheet.')
}
```

```{r, echo = FALSE}
if (all(pubs$pub.id %in% exper$pub.id)) {
  print('OK') 
} else {
  print('Some pub codes missing in Experiments sheet.')
}
```

## Complete citations given
```{r, echo = FALSE}
if (all(grepl('[Dd][Oo][Ii]', pubs$citation))) {
  print('OK') 
} else {
  print('DOI missing from Publications sheet.')
}
```

```{r, echo = FALSE}
if (all(nchar(pubs$citation) > 10)) {
  print('OK') 
} else {
  print('Citation details missing from Publications sheet.')
}
```

# Emission sheet check

```{r, echo = FALSE}
d <- dat[[i]][[j]]$emis
# Add first row in file info by plot
xx <- d[d$interval == 1, c('cpmid', 'row.in.file.int', 'row.in.file.plot')]
names(xx)[2:3] <- c('first.row.int', 'row.plot')
d <- merge(d, xx, by = 'cpmid')
```

## Duplicated intervals
```{r, echo = FALSE}
s <- ddply(d, 'cpmid', summarise, n.int.duplicates = sum(duplicated(interval)))
x <- subset(s, n.int.duplicates > 1)
if (nrow(x) > 0) {
  y <- subset(d, cpmid == x$cpmid)
  print('Some intervals duplicated:')
  print(y[, c('file', 'institute', 'row.in.file.int', 'plot', 'rep')])
} else {
  print('OK')
}
```

## Missing incorporation time

```{r, echo = FALSE}
x <- subset(d, incorp %in% c('deep', 'shallow') & is.na(time.incorp))
if (nrow(x) > 0) {
  print('Some problems')
  print(unique(as.character(x$file)))
  print(x[, c('file','row.in.file.int','institute')])
  print(table(d$incorp, d$time.incorp, exclude = NULL))
} else {
  print('OK')
}

```

## Delay after application
```{r,echo=FALSE}
if (min(d$bta) < 1) {
  print('OK')
} else {
  print('1 hr or longer delay after starting application')
  print('First 10 rows')
  kable(d[1:10, c('row.in.file.int', 'app.start', 't.start', 'bta', 'ct', 'cta')])
}
```

## Missing or double interval number
```{r,echo=FALSE}
for (ii in unique(emis$cpmid)) {
  #cat(ii)
  dd <- emis[emis$cpmid == ii, ]
  if (all(diff(dd$interval) == 1)) {
    cat('OK\n')
  } else {
    print('Problem, see following rows')
    print(dd$row.in.file.int[ii <- which(diff(dd$int) != 1)])
    print(dd[sort(unique(c(ii, ii-1, ii+1))), c('row.in.file.int', 'plot', 'interval', 't.start')])
  }
}
```

## Missing time between intervals
```{r,echo=FALSE}
for (ii in unique(emis$cpmid)) {
  dd <- emis[emis$cpmid == ii, ]
  if (all(dd$t.start[-1] == dd$t.end[-nrow(dd)])) {
    print('OK')
  } else {
    print('Problem, see following rows (compare start time to end time in previous rows):')
    ii <- which(c(FALSE, dd$t.start[-1] != dd$t.end[-nrow(dd)]))
    print(dd$row.in.file.int[ii])
    #print(dd[ii + -2:2, c('row.in.file.int', 'plot', 'interval', 't.start', 't.end')])
  }
}
```
# Value checks
## Weather
```{r, echo = FALSE}
lim <- data.frame(vari = c('wind', 'rain.rate', 'air.temp', 'soil.temp', 'soil.temp.surf', 'air.temp.z', 'wind.z'),
                  lwr = c(0, 0, -10, -10, -10, 0, 0),
                  upr = c(20, 20, 40, 40, 40, 10, 10))

for (k in lim$vari) {
  cat(k, ': ')
  vv <- na.omit(d[, k])
  if (length(vv) > 0) {
    if (all(vv >= lim[lim$vari == k, 'lwr'] & vv <= lim[lim$vari == k, 'upr'])) {
      cat('OK\n')
    } else {
      cat('Some values out of range\n')
      cat('Limits: ')
      print(lim[lim$vari == k,])
      cat('Range: ')
      print(range(vv))
      cat('Value table:\n')
      print(table(vv, exclude = NULL))
      cat('Missing values: ', sum(is.na(vv)),'\n')
    }
  } else {
    cat('No values to check.\n')
  }
}
```

## Manure and application
```{r, echo = FALSE}
lim <- data.frame(vari = c('man.stor', 'man.dm', 'man.vs', 'man.tkn', 'man.tan', 'man.tic', 'man.ua', 'man.vfa', 'man.ph', 'app.rate', 'crop.z'),
                  lwr = c(0, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0, 4, 1, 0),
                  upr = c(600, 20, 20, 10, 10, 10, 10, 20, 9.5, 200, 50))

for (k in lim$vari) {
  cat(k, ': ')
  vv <- na.omit(d[, k])
  if (length(vv) > 0) {
    if (all(vv >= lim[lim$vari == k, 'lwr'] & vv <= lim[lim$vari == k, 'upr'])) {
      cat('OK\n')
    } else {
      cat('Some values out of range\n')
      print(range(vv))
    }
  } else {
    cat('No values to check.\n')
  }
}
```

## Emission
```{r, echo = FALSE}
lim <- data.frame(vari = c('j.NH3', 'e.int', 'e.rel'),
                  lwr = c(-3, -30, -5),
                  upr = c(60, 200, 1.1))

for (k in lim$vari) {
  cat(k, ': ')
  vv <- na.omit(d[, k])
  if (length(vv) > 0) {
    if (all(vv >= lim[lim$vari == k, 'lwr'] & vv <= lim[lim$vari == k, 'upr'])) {
      cat('OK\n')
    } else {
      cat('Some values out of range\n')
      print(range(vv))
    }
  } else {
    cat('No values to check.\n')
  }
}
```

# Missing values
```{r,echo = FALSE}
miss <- apply(d, 2, function(x) sum(is.na(x)))
miss <- miss[miss > 0]
if (length(miss) > 0) {
  print('Some values missing:')
  print(miss)
} else {
  print('OK, no values missing')
}

print(miss[miss > 0])
```

# Application method and measurement method
```{r, echo=FALSE}
if (any(is.na(plots$app.method))) {
  print('Missing app.method in some rows')
} else {
  print('OK')
}
```
```{r, echo=FALSE}
if (any(is.na(plots$meas.tech))) {
  print('Missing measurement method in some rows')
} else {
  print('OK')
}
```

## Plots
## Calculated cumulative emission
Cumulative emission.
Missing values imputed (linear interpolation).
```{r, echo=FALSE}
d$first.row <- factor(paste(d$row.plot, d$first.row))
library(ggplot2)
ggplot(d, aes(ct, e.rel, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none') + facet_wrap(~ first.row)
ggplot(d, aes(ct, e.rel, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'top')
ggplot(d, aes(t.end, e.rel, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none')
ggplot(d, aes(t.end, e.rel, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none') + facet_wrap(~ first.row)
```

Final cumulative emission.

```{r, echo = FALSE}
ggplot(plots, aes(e.rel.final, fill = treat)) + geom_histogram() + facet_grid(meas.tech ~ .)
```


### Weather data
```{r, echo=FALSE}
ggplot(d, aes(ct, wind, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'top')
ggplot(d, aes(ct, air.temp, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none')
ggplot(d, aes(ct, rain.rate, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none')
ggplot(d, aes(ct, rain.cum, colour = first.row)) + geom_line() + geom_point() + theme(legend.position = 'none')
```

# Summary 
```{r, echo=FALSE}
print(dfsumm(d))
```

