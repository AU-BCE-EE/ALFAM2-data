
> # Load data from uptakes 1 and 2 (the original "ALFAM2" work)
> 
> idat.old <- read.csv('../../data-output/02/ALFAM2_interval.csv')

> pdat.old <- read.csv('../../data-output/02/ALFAM2_plot.csv')

> # 
> 
> # Date record
> print(Sys.time())
[1] "2023-11-11 07:56:07 EST"

> # Read and check data from files
> ddir <- list.dirs('../../data-submitted/03', recursive = FALSE)

> dat <- list()

> for(i in ddir) {
+   cat('Directory ', i,'\n')
+   f <- list.files(i, pattern = 'xls', full.names = TRUE)
+   # Omit temporary Excel files (created  .... [TRUNCATED] 
Directory  ../../data-submitted/03/AU 
   file  ../../data-submitted/03/AU/ALFAM2_JNK_2019_Aug_5_5_b.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Number of rows changed after plots/emis merge in cleanALAM()
May be entry error or multiple treatments per plot (i.e., no error)
(e.g., multiple parallel measurement methods)
Problem is often caused by plot/rep entry error.
Get in here with browser() and look at:
unique(plots.orig[, c('plot', 'rep')]) 
unique(emis[, c('plot', 'rep')])

[1] "File: ../../data-submitted/03/AU/ALFAM2_JNK_2019_Aug_5_5_b.xlsx"
plots:
            proj              exper field plot rep pub.id plot.area         lat
1 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 Atmos1    260000 56°27'12''N
2 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 Atmos1    260000 56°27'12''N
3 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 Atmos1    260000 56°27'12''N
4 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 Atmos1    260000 56°27'12''N
        long country
1 9°32'26''E      DK
2 9°32'26''E      DK
3 9°32'26''E      DK
4 9°32'26''E      DK
plots.orig:
            proj pub.id              exper field plot rep plot.area         lat
1 Vejrumbro_2019 Atmos1 Vejrumbro_2019_Aug          1   1    260000 56°27'12''N
        long country
1 9°32'26''E      DK
Unique emis:
              proj              exper field plot rep   treat meas.tech
1   Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 CRDS_1m       bLS
323 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1 CRDS_2m       bLS
645 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1      MD       bLS
967 Vejrumbro_2019 Vejrumbro_2019_Aug          1   1     AGM       AGM
    meas.tech.det
1         CRDS_1m
323       CRDS_2m
645            MD
967          <NA>
   file  ../../data-submitted/03/AU/ALFAM2_JNK_2019_May_5_6_a.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Number of rows changed after plots/emis merge in cleanALAM()
May be entry error or multiple treatments per plot (i.e., no error)
(e.g., multiple parallel measurement methods)
Problem is often caused by plot/rep entry error.
Get in here with browser() and look at:
unique(plots.orig[, c('plot', 'rep')]) 
unique(emis[, c('plot', 'rep')])

[1] "File: ../../data-submitted/03/AU/ALFAM2_JNK_2019_May_5_6_a.xlsx"
plots:
            proj              exper field plot rep pub.id plot.area         lat
1 Vejrumbro_2019 Vejrumbro_2019_May          1   1 Atmos1    260000 56°27'12''N
2 Vejrumbro_2019 Vejrumbro_2019_May          1   1 Atmos1    260000 56°27'12''N
3 Vejrumbro_2019 Vejrumbro_2019_May          1   1 Atmos1    260000 56°27'12''N
        long country
1 9°32'26''E      DK
2 9°32'26''E      DK
3 9°32'26''E      DK
plots.orig:
            proj pub.id              exper field plot rep plot.area         lat
1 Vejrumbro_2019 Atmos1 Vejrumbro_2019_May          1   1    260000 56°27'12''N
        long country
1 9°32'26''E      DK
Unique emis:
              proj              exper field plot rep   treat meas.tech
1   Vejrumbro_2019 Vejrumbro_2019_May          1   1 CRDS_1m       bLS
278 Vejrumbro_2019 Vejrumbro_2019_May          1   1 CRDS_2m       bLS
555 Vejrumbro_2019 Vejrumbro_2019_May          1   1     AGM       bLS
    meas.tech.det
1         CRDS_1m
278       CRDS_1m
555       CRDS_1m
Emission rate unit not available for conversion:  NA 
But  µgNH3/m2/s  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_210929_JP_CanadianData.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_211012_JP_18ABC.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgN/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_211012_JP_18GHI.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgN/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_211012_JP_18KLRS.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgN/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_211012_JP_18NOP.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_5_2_211012_JP_19BCHI.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_6_0_220126_JP_20CD21A_JP.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgNH3/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_6_0_220310_JP_20EFGH_v2.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgNH3/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_6_1_220317_JP_21CD22A.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_6_1_220524_JP_21E_220610.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Emission rate unit not available for conversion:  NA 
But  kgNH3/ha-hr  is OK.
See cleanALFAM() function.
   file  ../../data-submitted/03/AU/ALFAM2_template_6_1_230726_JP_18EF.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_6_1_230726_JP_19G20AB.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .   file  ../../data-submitted/03/AU/ALFAM2_template_6_1_eGylle_JK_3.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Did not find any publication info. . . might be good to double-check spreadsheet.
# A tibble: 1 × 1
  ``   
  <chr>
1 .    
   file  ../../data-submitted/03/AU/ALFAM2_template_6.1 SGS(Rev).xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Did not find any publication info. . . might be good to double-check spreadsheet.
# A tibble: 26 × 18
      `` ``    ``    ``    ``    ``    ``    ``    ``    ``    ``    ``    ``   
   <dbl> <chr> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl> <lgl>
 1     1 "3.\… NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 2    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 3    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 4    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 5    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 6    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 7    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 8    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
 9    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
10    NA  <NA> NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    NA   
# ℹ 16 more rows
# ℹ 5 more variables: `` <dbl>, `` <dbl>, `` <dbl>, `` <dbl>, `` <dbl>
# ℹ Use `print(n = ...)` to see more rows
   file  ../../data-submitted/03/AU/ALFAM2_template_7_0_eGylle_NL_DE_JK.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Did not find any publication info. . . might be good to double-check spreadsheet.
# A tibble: 1 × 1
  ``   
  <chr>
1 .    
Number of rows changed after plots/emis merge in cleanALAM()
May be entry error or multiple treatments per plot (i.e., no error)
(e.g., multiple parallel measurement methods)
Problem is often caused by plot/rep entry error.
Get in here with browser() and look at:
unique(plots.orig[, c('plot', 'rep')]) 
unique(emis[, c('plot', 'rep')])

[1] "File: ../../data-submitted/03/AU/ALFAM2_template_7_0_eGylle_NL_DE_JK.xlsx"
plots:
    proj   exper       field plot rep plot.area      lat     long country topo
1 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
2 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
3 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
4 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
5 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
6 eGylle eGylle3         WUR    1   1    1543.2 51.99500 5.647365      NL Flat
plots.orig:
    proj   exper       field plot rep plot.area      lat     long country topo
1 eGylle eGylle2 FoulumgårdD    1   1     778.2 56.49353 9.560641      DK Flat
2 eGylle eGylle3         WUR    1   1    1543.2 51.99500 5.647365      NL Flat
Unique emis:
      proj   exper       field plot rep                          treat
1   eGylle eGylle2 FoulumgårdD    1   1              eGylle_bLS_Alpha1
20  eGylle eGylle2 FoulumgårdD    1   1              eGylle_bLS_Alpha2
39  eGylle eGylle2 FoulumgårdD    1   1                    eGylle_DTM1
76  eGylle eGylle2 FoulumgårdD    1   1                    eGylle_DTM2
113 eGylle eGylle2 FoulumgårdD    1   1                    eGylle_DTM3
149 eGylle eGylle3         WUR    1   1                     eGylle_IHF
158 eGylle eGylle3         WUR    1   1            eGylle_bLS_avg_time
167 eGylle eGylle3         WUR    1   1 eGylle_bLS_acid_traps_3heights
176 eGylle eGylle3         WUR    1   1                    eGylle_FC_1
188 eGylle eGylle3         WUR    1   1                    eGylle_FC_2
200 eGylle eGylle3         WUR    1   1                    eGylle_FC_3
212 eGylle eGylle3         WUR    1   1                    eGylle_FC_4
          meas.tech  meas.tech.det
1               bLS Alpha samplers
20              bLS Alpha samplers
39              DTM           <NA>
76              DTM           <NA>
113             DTM           <NA>
149             IHF     Acid traps
158             bLS      CRDS avg.
167             bLS     Acid traps
176 Dynamic chamber     Acid traps
188 Dynamic chamber     Acid traps
200 Dynamic chamber     Acid traps
212 Dynamic chamber     Acid traps
   file  ../../data-submitted/03/AU/ALFAM2_template_7.0_DFCtest_JP_231108_JK.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Did not find any publication info. . . might be good to double-check spreadsheet.
# A tibble: 1 × 1
  ``   
  <chr>
1 .    
Directory  ../../data-submitted/03/DiSSA-IT 
   file  ../../data-submitted/03/DiSSA-IT/ALFAM2_data from Adani-Zilio_2.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Directory  ../../data-submitted/03/INIA 
Directory  ../../data-submitted/03/UNINA 
   file  ../../data-submitted/03/UNINA/ALFAM2_UNINA_5_6_1_ver6.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Directory  ../../data-submitted/03/UNINI 
   file  ../../data-submitted/03/UNINI/ALFAM2_template_6.1_ARMOSA2013_V1.xlsx 
  Starting. . .  Submitter info . . .  Contributors . . .  Experiments . . .  Treatments . . .  Plots . . .  Emission . . .  Publications . . .Did not find any publication info. . . might be good to double-check spreadsheet.
# A tibble: 1 × 1
  ``   
  <chr>
1 .    
Number of rows changed after plots/emis merge in cleanALAM()
May be entry error or multiple treatments per plot (i.e., no error)
(e.g., multiple parallel measurement methods)
Problem is often caused by plot/rep entry error.
Get in here with browser() and look at:
unique(plots.orig[, c('plot', 'rep')]) 
unique(emis[, c('plot', 'rep')])

[1] "File: ../../data-submitted/03/UNINI/ALFAM2_template_6.1_ARMOSA2013_V1.xlsx"
plots:
    proj   exper  field plot rep pub.id plot.area           lat        long
1 ARMOSA LAND_13 SIC-13    1   0     NA     39850 45° 19.312′ N 9° 15.763 E
2 ARMOSA LAND_13 SIC-13    1   0     NA     39850 45° 19.312′ N 9° 15.763 E
3 ARMOSA LAND_13 SIC-13    1   0     NA     39850 45° 19.312′ N 9° 15.763 E
4 ARMOSA LAND_13  SS-13    1   0     NA     10000 45° 19.271′ N 9° 16.476 E
  country
1      IT
2      IT
3      IT
4      IT
plots.orig:
    proj pub.id   exper  field plot rep plot.area           lat        long
1 ARMOSA     NA LAND_13 SIC-13    1   0     39850 45° 19.312′ N 9° 15.763 E
2 ARMOSA     NA LAND_13  SS-13    1   0     10000 45° 19.271′ N 9° 16.476 E
  country
1      IT
2      IT
Unique emis:
      proj   exper  field plot rep       treat meas.tech         meas.tech.det
1   ARMOSA LAND_13 SIC-13    1   0   SIC-13_EC        EC         150 cm height
285 ARMOSA LAND_13 SIC-13    1   0  SIC-13_IDM       bLS         150 cm height
569 ARMOSA LAND_13 SIC-13    1   0 SIC-13_TAGM       AGM 30, 70, 150 cm height
853 ARMOSA LAND_13  SS-13    1   0   SS-13_IDM       bLS         150 cm height
Directory  ../../data-submitted/03/WUR 

> cat('Done! Read', length(dat), ' directories\n')
Done! Read 6  directories

> print(warnings())
Warning messages:
1: Expecting logical in AE2944 / R2944C31: got 'hPa'
2: Expecting logical in AH2944 / R2944C34: got 'Field'
3: Expecting logical in AE2945 / R2945C31: got 'hPa'
4: Expecting logical in AH2945 / R2945C34: got 'Field'
5: Expecting logical in AE2946 / R2946C31: got 'hPa'
6: Expecting logical in AH2946 / R2946C34: got 'Field'
7: Expecting logical in AE2947 / R2947C31: got 'hPa'
8: Expecting logical in AH2947 / R2947C34: got 'Field'
9: Expecting logical in AE2948 / R2948C31: got 'hPa'
10: Expecting logical in AH2948 / R2948C34: got 'Field'
11: Expecting logical in AE2949 / R2949C31: got 'hPa'
12: Expecting logical in AH2949 / R2949C34: got 'Field'
13: Expecting logical in AE2950 / R2950C31: got 'hPa'
14: Expecting logical in AH2950 / R2950C34: got 'Field'
15: Expecting logical in AE2951 / R2951C31: got 'hPa'
16: Expecting logical in AH2951 / R2951C34: got 'Field'
17: Expecting logical in AE2952 / R2952C31: got 'hPa'
18: Expecting logical in AH2952 / R2952C34: got 'Field'
19: Expecting logical in AE2953 / R2953C31: got 'hPa'
20: Expecting logical in AH2953 / R2953C34: got 'Field'
21: Expecting logical in AE2954 / R2954C31: got 'hPa'
22: Expecting logical in AH2954 / R2954C34: got 'Field'
23: Expecting logical in AE2955 / R2955C31: got 'hPa'
24: Expecting logical in AH2955 / R2955C34: got 'Field'
25: Expecting logical in AE2956 / R2956C31: got 'hPa'
26: Expecting logical in AH2956 / R2956C34: got 'Field'
27: Expecting logical in AE2957 / R2957C31: got 'hPa'
28: Expecting logical in AH2957 / R2957C34: got 'Field'
29: Expecting logical in AE2958 / R2958C31: got 'hPa'
30: Expecting logical in AH2958 / R2958C34: got 'Field'
31: Expecting logical in AE2959 / R2959C31: got 'hPa'
32: Expecting logical in AH2959 / R2959C34: got 'Field'
33: Expecting logical in AE2960 / R2960C31: got 'hPa'
34: Expecting logical in AH2960 / R2960C34: got 'Field'
35: Expecting logical in AE2961 / R2961C31: got 'hPa'
36: Expecting logical in AH2961 / R2961C34: got 'Field'
37: Expecting logical in AE2962 / R2962C31: got 'hPa'
38: Expecting logical in AH2962 / R2962C34: got 'Field'
39: Expecting logical in AE2963 / R2963C31: got 'hPa'
40: Expecting logical in AH2963 / R2963C34: got 'Field'
41: Expecting logical in AE2964 / R2964C31: got 'hPa'
42: Expecting logical in AH2964 / R2964C34: got 'Field'
43: Expecting logical in AE2965 / R2965C31: got 'hPa'
44: Expecting logical in AH2965 / R2965C34: got 'Field'
45: Expecting logical in AE2966 / R2966C31: got 'hPa'
46: Expecting logical in AH2966 / R2966C34: got 'Field'
47: Expecting logical in AE2967 / R2967C31: got 'hPa'
48: Expecting logical in AH2967 / R2967C34: got 'Field'
49: Expecting logical in AE2968 / R2968C31: got 'hPa'
50: Expecting logical in AH2968 / R2968C34: got 'Field'

> # Check for errors and create a log before merge
> 
> for (i in names(dat)) {
+   for (j in names(dat[[i]])) {
+ 
+     # Check for errors and creat .... [TRUNCATED] 

> # Sort out int- and plot-level flags
> 
> for (i in names(dat)) {
+   for (j in names(dat[[i]])) {
+ 
+     dat[[i]][[j]] <- addFlags(dat[[i]][[j]]) .... [TRUNCATED] 

> # Pull new data from list
> 
> # Stack individual interval and plot level data frames from each file together
> pdat <- idat <- data.frame()

> # Extract and stack plot and interval level data
> for (i in dat) {
+   for (j in i) {
+     pdat <- rbindf(pdat, j$plots)
+     idat <- rbindf(idat .... [TRUNCATED] 

> # Add plot and institute ID codes to new data
> 
> # Get original pmid from latest GitHub release
> 
> p <- paste0('https://github.com/sashahafner/A .... [TRUNCATED] 

> pdatr <- as.data.frame(data.table::fread(paste0(p, '/data-output/03/ALFAM2_plot.csv.gz'))[uptake == 3, .(uptake, institute, proj, file, exper, field .... [TRUNCATED] 

> dim(pdatr)
[1] 348  16

> dim(pdat)
[1] 430 226

> # Extract and reuse old institute codes
> inst.old <- unique(pdat.old[, c('institute', 'inst')])

> pdat <- merge(pdat, inst.old, by = 'institute', all.x = TRUE)

> # Create completley new 300s codes for new institutes
> # NTS: needs tweak to leave out inst codes already recognized so e.g., 301 is not skipped
>  .... [TRUNCATED] 

> # ID codes created in plots data frame and then merged into interval level data frame
> # First add ones already created in earlier release, to avoi .... [TRUNCATED] 

> # Experiment ID (includes uptake, inst, proj, exper)
> pdat$eid[is.na(pdat$eid)] <- as.integer(factor(pdat$ceid[is.na(pdat$eid)])) + max(c(pdat.old$ .... [TRUNCATED] 

> # Add plot and plot x meas tech IDs
> pdat$pid[is.na(pdat$pid)] <- as.integer(factor(pdat$cpid[is.na(pdat$pid)])) + max(c(pdat.old$pid, na.omit(pdat .... [TRUNCATED] 

> pdat$pmid[is.na(pdat$pmid)] <- as.integer(factor(pdat$cpmid[is.na(pdat$pmid)])) + max(c(pdat.old$pmid, na.omit(pdat$pmid)))

> # Merge IDs into interval level data
> # Should alternatively be able to switch to interger directly in idat
> idat <- merge(idat, pdat[, c('cpmid', .... [TRUNCATED] 

> # Add observation ID
> # Is not copied from earlier uptake but because any new obs (should) have a large pmid, they will also have a higher oid
> id .... [TRUNCATED] 

> idat$oid <- 1:nrow(idat) + max(idat.old$oid)

> # Combine new (uptake 3) with old data
> 
> # First plot-level data
> # Rename some old columns
> names(pdat.old)[names(pdat.old) %in% c('first.row. .... [TRUNCATED] 

> names(pdat.old)[names(pdat.old) == 'row.in.file'] <- 'row.in.file.plot'

> names(pdat.old)[names(pdat.old) == 'database'] <- 'uptake'

> names(pdat.old)[names(pdat.old) == 'notes'] <- 'notes.plot'

> names(pdat.old)[names(pdat.old) == 'flag'] <- 'flag.plot'

> # And drop others
> pdat.old$man.freeNH3 <- pdat.old$man.eq.gasNH3 <- NULL

> # Combine
> pdat.comb <- rbindf(pdat, pdat.old)

> # Select and order columns (and order rows)
> pdat.comb <- pdat.comb[order(pdat.comb$pmid), 
+   c('inst', 'eid', 'pid', 'pmid', 
+     'uptake', 'p .... [TRUNCATED] 

> # Round
> pdat.comb <- rounddf(pdat.comb, 5, func = signif)

> ## Checks:
> ## Columns missing in new data
> #names(pdat.old)[!names(pdat.old) %in% intersect(names(pdat), names(pdat.old))]
> ## Columns missing i .... [TRUNCATED] 

> # Combine old and new interval-level data
> 
> # Interval-level data
> # Remove some old columns
> idat.old$man.freeNH3 <- idat.old$man.eq.gasNH3 <- .... [TRUNCATED] 

> # Rename some old columns
> names(idat.old)[names(idat.old) == 'row.in.file'] <- 'row.in.file.int'

> names(idat.old)[names(idat.old) == 'database'] <- 'uptake'

> names(idat.old)[names(idat.old) == 'notes'] <- 'notes.int'

> names(idat.old)[names(idat.old) == 'flag'] <- 'flag.int'

> # Combine
> idat.comb <- rbindf(idat, idat.old)

> # Order and select columns for database distribution
> # Note that objective is to keep file size small, so most columns in plot-level data frame ar .... [TRUNCATED] 

> # Add int suffix to weather height info (because it is also in plot data frame, pulled from emis row 1)
> nn <- c('soil.temp.z', 'air.temp.z', 'wind .... [TRUNCATED] 

> names(idat.comb)[names(idat.comb) %in% nn] <- paste0(nn, '.int')

> # Round 
> idat.comb <- rounddf(idat.comb, 5, func = signif)

> ## Checks
> ## Columns missing in new data
> #names(idat.old)[!names(idat.old) %in% intersect(names(idat), names(idat.old))]
> ## Columns missing in .... [TRUNCATED] 

> # Make text plot summaries for uptake 3 only
> 
> for (i in unique(pdat$file)) {
+ 
+   fn <- strsplit(i, '/')
+   fn <- fn[[1]][length(fn[[1]])]
+  .... [TRUNCATED] 

> # Saves a copy of plot and internval data by flie
> # Main purpose is to have a text-based (works with Git) record of submitted data
> 
> for (i in  .... [TRUNCATED] 

> knit('check_final.Rmd', output = '../../logs/03/check_final.md', quiet = TRUE)
[1] "../../logs/03/check_final.md"

> # Compare version number to what is on GitHub
> 
> # Latest pushed dev
> lastdev <- 'https://raw.githubusercontent.com/sashahafner/ALFAM2-data/dev/d .... [TRUNCATED] 

> # Latest pushed main
> lastmain <- 'https://raw.githubusercontent.com/sashahafner/ALFAM2-data/master/data-output/03/data_version.txt'

> # Latest release
> release <- paste0('https://github.com/sashahafner/ALFAM2-data/raw/v', oldrelease, '/data-output/03/data_version.txt')

> # Latest pushed dev
> vld <- gsub('\\.$', '', as.data.frame(data.table::fread(lastdev))[[3]])

> # Latest pushed main
> vlm <- gsub('\\.$', '', as.data.frame(data.table::fread(lastmain))[[3]])

> # Latest release
> vr <- gsub('\\.$', '', as.data.frame(data.table::fread(release))[[3]])

> cat('Checking versions\n')
Checking versions

> if (oldrelease != vr) {
+   cat('Version number in old release does not match release tag!\n')
+ }

> vdat <- data.frame(Where = c('main.R (new version)', 'Release tag', 'Release', 'Main branch', 'Dev branch'),
+                    Version = c(versio .... [TRUNCATED] 

> cat('\n')


> print(vdat, row.names = FALSE)
                Where Version
 main.R (new version)    2.28
          Release tag    2.23
              Release    2.23
          Main branch    2.27
           Dev branch    2.26

> if (version %in% c(oldrelease, vr, vlm, vld)) {
+   warning('Version number set in main.R matches\n   one or more existing verion numbers!\n   Did y .... [TRUNCATED] 

> # Write regular csv files
> write.csv(pdat.comb, '../../data-output/03/ALFAM2_plot.csv', row.names = FALSE)

> write.csv(idat.comb, '../../data-output/03/ALFAM2_interval.csv', row.names = FALSE)

> # And then compress them
> R.utils::gzip('../../data-output/03/ALFAM2_plot.csv', overwrite = TRUE)

> R.utils::gzip('../../data-output/03/ALFAM2_interval.csv', overwrite = TRUE)

> # Record data version also
> cat(paste0('Database version: ', version, '. Date created: ', Sys.time()), file = '../../logs/03/data_version.txt')

> cat(paste0('Database version: ', version, '. Date created: ', Sys.time()), file = '../../data-output/03/data_version.txt')
